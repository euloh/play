<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="DC.Type" content="topic">
      <meta name="DC.Title" content="Tracing User-Space Applications">
      <meta name="DC.Publisher" content="January2025">
      <meta name="category" content="operating-systems">
      <meta name="suite" content="linux">
      <meta name="productGroup" content="not-applicable">
      <meta name="product" content="oracle-linux">
      <meta name="release" content="cross-release">
      <meta name="docbuilderDocument" content="mydocs-linux_oracle-linux_dtrace-tutorial">
      <meta name="docbuilderId" content="22354">
      <meta name="pubAlias" content="dtrace-tutorial">
      <meta name="jarvis-url" content="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-tutorial/">
      <meta name="notice" content="notice.txt">
      <meta name="ditaval" content="dttutor.ditaval">
      <meta name="revision" content="$Rev$">
      <meta name="rev-date" content="$Date$">
      <meta name="title" content="Oracle Linux: DTrace Tutorial">
      <meta name="DC.Format" content="XHTML">
      <meta name="DC.Identifier" content="ol_upacexmp_dtrace">
      <meta name="DC.Language" content="en-us">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Tracing User-Space Applications</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="DTrace Tutorial">
      <meta property="og:description" content>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="DTrace Tutorial">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="OL-DTRACE-TUTORIAL.pdf" title="PDF File" type="application/pdf">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2025-01-13T07:08:07-08:00">
      
      <meta name="dcterms.dateCopyrighted" content="2013, 2025">
      <meta name="dcterms.category" content="operating-systems">
      <meta name="dcterms.identifier" content="E50705-16">
      
      <meta name="dcterms.product" content="en/operating-systems/oracle-linux">
      
      <link rel="prev" href="dtrace-tutorial-TracingOperatingSystemBehavior.html" title="Previous" type="text/html">
      <link rel="next" href="dtrace-tutorial-GoingFurtherWithDTrace.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"operating-systems","element_name":"Operating Systems","display_in_url":true},"suite":{"short_name":"linux","element_name":"Oracle Linux","display_in_url":false},"product_group":{"short_name":"not-applicable","element_name":"Not Applicable","display_in_url":false},"product":{"short_name":"oracle-linux","element_name":"Oracle Linux","display_in_url":true},"release":{"short_name":"cross-release","element_name":"Cross Release","display_in_url":false}}}</script>
      
    <meta name="dcterms.title" content="Oracle Linux: DTrace Tutorial">
    <meta name="dcterms.isVersionOf" content="DTRACE-TUTORIAL">
    <meta name="dcterms.release" content="Cross Release">
  <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","name":"Tracing User-Space Applications","datePublished":"2019-08-16 CST","dateModified":"2025-01-13 CST"} </script>
    <script>window.ohcglobal || document.write('<script src="/en/dcommon/js/global.js">\x3C/script>')</script></head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="dtrace-tutorial-TracingOperatingSystemBehavior.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="dtrace-tutorial-GoingFurtherWithDTrace.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">DTrace Tutorial</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">Tracing User-Space Applications</li>
            </ol>
            <a id="ol_upacexmp_dtrace" name="ol_upacexmp_dtrace"></a>
            
            <h2 id="OLDTT-ol_upacexmp_dtrace" class="sect2"><span class="enumeration_chapter">3 </span>Tracing User-Space Applications
            </h2>
         </header>
         <div class="ind">
            <div>
               <div>
                  
                  <div class="infoboxnotewarn">
                     <p class="notep1">WARNING:</p>
                     
                     <p>Oracle Linux 7 is now in Extended Support. See <a href="https://www.oracle.com/a/ocom/docs/linux/oracle-linux-extended-support-ds.pdf" target="_blank">Oracle Linux Extended Support</a> and <a href="https://www.oracle.com/us/support/library/enterprise-linux-support-policies-069172.pdf" target="_blank">Oracle Open Source Support Policies</a> for more information.
                     </p>
                     
                     <p>
Migrate applications and data to Oracle Linux 8 or Oracle Linux 9 as soon as possible.
</p>
                     
                     <p>For more information about DTrace, see <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-relnotes/" target="_blank"><span class="italic">Oracle Linux: DTrace Release Notes</span></a> and <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-v2-guide/" target="_blank">Oracle Linux: Using DTrace for System Tracing</a>.
                     </p>
                     
                  </div>
                  
               </div>
               <p>
      This chapter provides information about how to trace a user-space
      application and includes examples of D programs that you can use
      to investigate what is happening in an example user-space program.
    </p>
            </div>
            <div class="sect2"><a id="ol_helper_dtrace" name="ol_helper_dtrace"></a><h3 id="OLDTT-ol_helper_dtrace" class="sect3">Preparing for Tracing User-Space Applications</h3>
               <div>
                  <p>
      The DTrace helper device (<code class="codeph">/dev/dtrace/helper</code>)
      enables a user-space application that contains DTrace probes to
      send probe provider information to DTrace.
    
                  </p>
                  <p>
      To trace user-space processes that are run by users other than
      <code class="codeph">root</code>, you must change the mode of the DTrace
      helper device to allow the user to record tracing information, as
      shown in the following examples.
    
                  </p>
               </div>
               <div class="sect3"><a id="ol_helper_dtrace_mode" name="ol_helper_dtrace_mode"></a><h4 id="OLDTT-ol_helper_dtrace_mode" class="sect4">Example: Changing the Mode of the DTrace Helper Device</h4>
                  <div>
                     <p><a id="d5322e135" class="indexterm-anchor"></a>

        The following example shows how you would enable the tracing of
        user-space applications by users other than the
        <code class="codeph">root</code> user.
      
                     </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">chmod 666 /dev/dtrace/helper</kbd></pre><p>
        Alternatively, if the <code class="codeph">acl</code> package is
        installed on your system, you would use an ACL rule to limit
        access to a specific user, for example:
      
                     </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">setfacl -m u:guest:rw /dev/dtrace/helper</kbd></pre><div class="infoboxnote">
                        <p class="notep1">Note:</p>
                        
                        <p>
          For DTrace to reference the probe points, you must change the
          mode on the device before the user begins running the program.
        </p>
                        
                     </div>
                     <p>
        You can also create a <code class="codeph">udev</code> rules file such as
        <code class="codeph">/etc/udev/rules.d/10-dtrace.rules</code> to change
        the permissions on the device file each time the system boots.
      
                     </p>
                     <p>
        The following example shows how you would change the mode of the
        device file by adding the following line to the
        <code class="codeph">udev</code> rules file:
      
                     </p><pre class="oac_no_warn" dir="ltr">kernel=="dtrace/helper", MODE="0666"</pre><p>
        The following example shows how you would change the ACL
        settings for the device file by adding a line similar to the
        following to the <code class="codeph">udev</code> rules file:
      
                     </p><pre class="oac_no_warn" dir="ltr">kernel=="dtrace/helper", RUN="/usr/bin/setfacl -m u:guest:rw /dev/dtrace/helper"</pre><p>
        To apply the <code class="codeph">udev</code> rule without needing to
        restart the system, you would run the
        <span class="bold">start_udev</span> command.
      
                     </p>
                  </div>
               </div>
            </div>
            <div class="sect2"><a id="dtrace_sample_app" name="dtrace_sample_app"></a><h3 id="OLDTT-dtrace_sample_app" class="sect3">Sample Application</h3>
               <div>
                  <p>
      This section provides a sample application to be used in
      subsequent exercises and examples in this chapter. The example,
      which illustrates a simple program, favors brevity and probing
      opportunity rather than completeness or efficiency.
    </p>
                  <div class="infoboxnote">
                     <p class="notep1">Note:</p>
                     
                     <p>
        The following simple program is provided for example purposes
        <span class="italic">only</span> and is not intended to efficiently
        solve a practical problem nor exhibit preferred coding methods.
      
                     </p>
                     
                  </div>
                  <p>
      The sample program finds the lowest factor of a number, which you
      input. The program is comprised of the following four files:
      <code class="codeph">makefile</code>, <code class="codeph">primelib.h</code>,
      <code class="codeph">primelib.c</code>, and <code class="codeph">primain.c</code> ,
      which are stored in the same working directory.
    
                  </p>
               </div>
               <div class="sect3"><a id="sampleapp_makefile_example" name="sampleapp_makefile_example"></a><h4 id="OLDTT-sampleapp_makefile_example" class="sect4">Description and Format of the makefile File</h4>
                  <div>
                     <p>
        The following example shows the contents of the
        <code class="codeph">makefile</code> file.
      
                     </p>
                     <div class="infoboxnote">
                        <p class="notep1">Note:</p>
                        
                        <p>
          A <code class="codeph">makefile</code> must use tabs for indentation so
          that the <code class="codeph">make</code> command can function
          properly. Also, be sure that tabs are retained if the file is
          copied and then used.
        
                        </p>
                        
                     </div><pre class="oac_no_warn" dir="ltr">default: prime

# compile the library primelib first
primelib.o: primelib.c
	gcc -c primelib.c

# compile the main program
primain.o: primain.c
	gcc -c primain.c

# link and create executable file "prime"
prime: primelib.o primain.o
	gcc primain.o primelib.o -o prime -lm

clean:
	-rm -f *.o
	-rm -f prime</pre></div>
               </div>
               <div class="sect3"><a id="sampleapp_primelibh_example" name="sampleapp_primelibh_example"></a><h4 id="OLDTT-sampleapp_primelibh_example" class="sect4">Description of the primelib.h Source File</h4>
                  <div>
                     <p>
        The following example shows the contents of the
        <code class="codeph">primelib.h</code> file.
      
                     </p><pre class="oac_no_warn" dir="ltr">int findMaxCheck( int inValue );
int seekFactorA( int input, int maxtry );
int seekFactorB( int input );</pre></div>
               </div>
               <div class="sect3"><a id="sampleapp_primelibc_example" name="sampleapp_primelibc_example"></a><h4 id="OLDTT-sampleapp_primelibc_example" class="sect4">Description of the primelib.c Source File</h4>
                  <div>
                     <p>
        The following example shows the contents of the
        <code class="codeph">primelib.c</code> file.
      
                     </p><pre class="oac_no_warn" dir="ltr">#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

/*
 * utility functions which are called from the main source code
 */

// Find and return our highest value to check -- which is the square root
int findMaxCheck( int inValue )  {
  float sqRoot;
  sqRoot = sqrt( inValue );
  printf("Square root of %d is %lf\n", inValue, sqRoot); 
  return floor( sqRoot );
  return inValue/2;
}

int debugFlag = 0;

// Search for a factor to the input value, proving prime on return of zero
int seekFactorA( int input, int maxtry )  {
  int divisor, factor = 0;
  for( divisor=2; divisor&lt;=maxtry; ++divisor ) {
    if( 0 == input%divisor ) {
      factor = divisor;
      break;
    }
    else if ( debugFlag != 0 )
      printf( "modulo %d yields: %d\n", divisor, input%divisor );
  }
  return factor;
}

// Search for a factor to the input value, proving prime on return of zero
// This is a different method than "A", using one argument
int seekFactorB( int input )  {
  int divisor, factor = 0;
  if( 0 == input%2 ) return 2;
  for( divisor=3; divisor&lt;=input/2; divisor+=2 ) {
    if( 0 == input%divisor ) {
      factor = divisor;
      break;
    }
  }
  return factor;
}</pre></div>
               </div>
               <div class="sect3"><a id="sampleapp-primec-example" name="sampleapp-primec-example"></a><h4 id="OLDTT-sampleapp-primec-example" class="sect4">Description of the primain.c Source File</h4>
                  <div>
                     <p>
        The following example shows the contents of the
        <code class="codeph">primain.c</code> file.
      
                     </p><pre class="oac_no_warn" dir="ltr">#include &lt;stdio.h&gt;
#include "primelib.h"

/*
 * Nominal C program churning to provide a code base we might want to
 * instrument with D
*/

// Search for a divisor -- thereby proving composite value of the input.
int main()  {
  int targVal, divisor, factorA=0, factorB=0;

  printf( "Enter a positive target integer to test for prime status: " );
  scanf( "%d", &amp;targVal );

  // Check that the user input is valid
  if( targVal &lt; 2 ) {
    printf( "Invalid input value -- exiting now\n" );
    return -2;
  }

  // Search for a divisor using method and function A
  int lastCheck;
  lastCheck = findMaxCheck( targVal );
  printf( "%d highest value to check as divisor\n", lastCheck );
  factorA = seekFactorA( targVal, lastCheck );

  // Search for a divisor using method and function B
  factorB = seekFactorB( targVal );

  // Warn if the methods give different results
  if (factorA != factorB)
    printf( "%d does not equal %d! How can this be?\n", factorA, factorB );

  // Print results
  if( !factorA )
    printf( "%d is a prime number\n", targVal );
  else
    printf( "%d is not prime because there is a factor %d\n",
	    targVal, factorA );
  return 0;
}</pre></div>
               </div>
               <div class="sect3"><a id="ol_compileprogram_exercise" name="ol_compileprogram_exercise"></a><h4 id="OLDTT-ol_compileprogram_exercise" class="sect4">Compiling the Program and Running the prime Executable</h4>
                  <div>
                     <p>
        With the four files previously described located in the same
        working directory, compile the program by using the
        <kbd class="userinput">make</kbd> command as follows:
      
                     </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">make</kbd>
gcc -c primelib.c
gcc -c primain.c
gcc primain.o primelib.o -o prime -lm</pre><p>
        Running the <kbd class="userinput">make</kbd> command creates an
        executable named <code class="codeph">prime</code>, which can be run to
        find the lowest prime value of the input, as shown in the
        following two examples:
      
                     </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 5099
Square root of 5099 is 71.407280
71 highest value to check as divisor
5099 is a prime number</pre><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime</kbd>
Enter a positive target integer to test for prime status: 95099
Square root of 95099 is 308.381256
308 highest value to check as divisor
95099 is not prime because there is a factor 61</pre><p>
        After compiling the program and running the
        <kbd class="userinput">prime</kbd> executable, you can practice adding
        USDT probes to an application, as described in
        <a href="dtrace-tutorial-TracingUserSpaceApplications.html#addusdt_probes">Adding USDT Probes to an Application</a>.
      
                     </p>
                  </div>
               </div>
            </div>
            <div class="sect2"><a id="addusdt_probes" name="addusdt_probes"></a><h3 id="OLDTT-addusdt_probes" class="sect3">Adding USDT Probes to an Application</h3>
               <div>
                  <p>
      In this section, we practice adding USDT probes to an application.
      For background information and other details, see
      <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/dtrace-ref-StaticallyDefinedTracingofUserApplications.html#dt_addpa_sdt" target="_blank">Adding
      Probes to an Application</a> in the
      <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/" target="_blank">Oracle Linux: DTrace Reference Guide</a>.
    
                  </p>
                  <p>
      To get started, you will need to create a <code class="codeph">.d</code>
      file, as described in
      <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/dtrace-ref-StaticallyDefinedTracingofUserApplications.html#dt_defpp_sdt" target="_blank">Defining
      Providers and Probes</a> in the
      <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/" target="_blank">Oracle Linux: DTrace Reference Guide</a>.
    
                  </p>
                  <div class="infoboxnote">
                     <p class="notep1">Note:</p>
                     
                     <p>
        This <code class="codeph">.d</code> file is not a script that is run in
        the same way that is shown in previous examples in this
        tutorial, but is rather the <code class="codeph">.d</code> source file
        that you use when compiling and linking your application. To
        avoid any confusion, use a different naming convention for this
        file than you use for scripts.
      
                     </p>
                     
                  </div>
                  <p>
      After creating the <code class="codeph">.d</code> file, you then need to
      create the required probe points to use in the following examples.
      This information is added to the <code class="codeph">primain.c</code>
      source file. The probe points that are used in this practice are
      those listed in the following table. These probes represent a
      sequence of operations and are used after the user entry is
      completed and checked.
    
                  </p>
                  <div class="tblformal">
                     <p class="titleintable">Table 3-1 Probe Points to Use After User Entry Completed and Checked</p>
                     <table cellpadding="4" cellspacing="0" class="Formal" title="Probe Points to Use After User Entry Completed and Checked" summary="&#xA;        This table includes a description of the data and points&#xA;        to be probed after user entry is completed and checked. Each&#xA;        probe point represents a sequence of operations.&#xA;      " frame="hsides" border="1" rules="rows">
                        <thead>
                           <tr align="left" valign="top">
                              <th align="left" valign="bottom" id="d5322e562">
              
                Description
              
            </th>
                              <th align="left" valign="bottom" id="d5322e567">
              
                Probe
              
            </th>
                           </tr>
                        </thead>
                        <tbody>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" id="d5322e574" headers="d5322e562 ">
                                 
                                 <p>
                User entry complete and checked
              </p>
                                 
                              </td>
                              <td align="left" valign="top" headers="d5322e574 d5322e567 ">
                                 
                                 <p><code class="codeph">userentry( int </code>)
              
                                 </p>
                                 
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" id="d5322e587" headers="d5322e562 ">
                                 
                                 <p>
                Return and input to <code class="codeph"> seekFactorA()</code>
                                    
                                 </p>
                                 
                              </td>
                              <td align="left" valign="top" headers="d5322e587 d5322e567 ">
                                 
                                 <p>
                                    <code class="codeph">factorreturnA( int, int )</code>
                                    
                                 </p>
                                 
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" id="d5322e604" headers="d5322e562 ">
                                 
                                 <p>
                Return and input to <code class="codeph"> seekFactorB()</code>
                                    
                                 </p>
                                 
                              </td>
                              <td align="left" valign="top" headers="d5322e604 d5322e567 ">
                                 
                                 <p>
                                    <code class="codeph">factorreturnB( int, int )</code>
                                    
                                 </p>
                                 
                              </td>
                           </tr>
                           <tr align="left" valign="top">
                              <td align="left" valign="top" id="d5322e621" headers="d5322e562 ">
                                 
                                 <p>
                Immediately prior to the program exiting
              </p>
                                 
                              </td>
                              <td align="left" valign="top" headers="d5322e621 d5322e567 ">
                                 
                                 <p>
                                    <code class="codeph">final()</code>
                                    
                                 </p>
                                 
                              </td>
                           </tr>
                        </tbody>
                     </table>
                  </div>
                  <!-- class="inftblhruleinformal" -->
               </div>
               <div class="sect3"><a id="probeadd_dprime_exercise" name="probeadd_dprime_exercise"></a><h4 id="OLDTT-probeadd_dprime_exercise" class="sect4">Exercise: Creating a dprime.d File</h4>
                  <div>
                     <p><a id="d5322e666" class="indexterm-anchor"></a>

        To reflect the previously described probe points and data,
        create a file named <code class="codeph">dprime.d</code> and store the
        file in the same working directory as the other source files.
      
                     </p>
                     <div class="infoboxnote">
                        <p class="notep1">Note:</p>
                        
                        <p>
          Typically, you would provide additional information in the
          <code class="codeph">.d</code> file, such as stability attributes, per
          the details that were previously referenced in the
          <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/" target="_blank">Oracle Linux: DTrace Reference Guide</a>.
          For the sake of brevity, expedience, and simplicity, those
          details are not included in this introductory example.
        
                        </p>
                        
                     </div>
                     <p>
        (Estimated completion time: less than 5 minutes)
      </p>
                  </div>
               </div>
               <div class="sect3"><a id="probeadd_dprime_solution" name="probeadd_dprime_solution"></a><h4 id="OLDTT-probeadd_dprime_solution" class="sect4">Solution to Exercise: Creating a dprime.d File

        <span></span>
                     
                  </h4>
                  <div><pre class="oac_no_warn" dir="ltr">provider primeget
{
  probe query__userentry( int );
  probe query__maxcheckval( int, int );
  probe query__factorreturnA( int, int );
  probe query__factorreturnB( int, int );
  probe query__final();
};</pre></div>
               </div>
               <div class="sect3"><a id="usdtprobe_createh_Example" name="usdtprobe_createh_Example"></a><h4 id="OLDTT-usdtprobe_createh_Example" class="sect4">Example: Creating a .h File From a dprime.d File</h4>
                  <div>
                     <p><a id="d5322e756" class="indexterm-anchor"></a>

        The next step is to create a <code class="codeph">.h</code> file from the
        <code class="codeph">dprime.d</code> file, as shown here:
      
                     </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -h -s dprime.d</kbd></pre><p>
        The <code class="codeph">dprime.h</code> file that is created contains a
        reference to each of the probe points that are defined in the
        <code class="codeph">dprime.d</code> file.
      
                     </p>
                     <p>
        Next, in the application source file,
        <code class="codeph">primain.c</code>, we add a reference to the
        <code class="codeph">#include "dprime.h"</code> file and add the
        appropriate probe macros at the proper locations.
      
                     </p>
                     <p>
        In the resulting <code class="codeph">primain.c</code> file, the probe
        macros (shown in bold font for example purposes only) are easy
        to recognize, as they appear in uppercase letters:
      
                     </p><pre class="oac_no_warn" dir="ltr">#include &lt;stdio.h&gt;
#include "primelib.h"
<span class="bold">#include "dprime.h"</span>

/*
 * Nominal C program churning to provide a code base we might want to
 * instrument with D
*/

// Search for a divisor -- thereby proving composite value of the input.
int main()  {
  int targVal, divisor, factorA=0, factorB=0;

  printf( "Enter a positive target integer to test for prime status: " );
  scanf( "%d", &amp;targVal );

  // Check that the user input is valid
  if( targVal &lt; 2 ) {
    printf( "Invalid input value -- exiting now\n" );
    return -2;
  }
  <span class="bold">if (PRIMEGET_QUERY_USERENTRY_ENABLED())
    PRIMEGET_QUERY_USERENTRY(targVal);</span>

  // Search for a divisor using method and function A
  int lastCheck;
  lastCheck = findMaxCheck( targVal );
  printf( "%d highest value to check as divisor\n", lastCheck );
  <span class="bold">if (PRIMEGET_QUERY_MAXCHECKVAL_ENABLED())
    PRIMEGET_QUERY_MAXCHECKVAL(lastCheck, targVal);</span>

  factorA = seekFactorA( targVal, lastCheck );
  <span class="bold">if (PRIMEGET_QUERY_FACTORRETURNA_ENABLED())
    PRIMEGET_QUERY_FACTORRETURNA(factorA, targVal);</span>

  // Search for a divisor using method and function B
  factorB = seekFactorB( targVal );
 <span class="bold">if (PRIMEGET_QUERY_FACTORRETURNB_ENABLED())
    PRIMEGET_QUERY_FACTORRETURNB(factorB, targVal);</span>

  // Warn if the methods give different results
  if (factorA != factorB)
    printf( "%d does not equal %d! How can this be?\n", factorA, factorB );

  // Print results
  if( !factorA )
    printf( "%d is a prime number\n", targVal );
  else
    printf( "%d is not prime because there is a factor %d\n",
	    targVal, factorA );
  <span class="bold">if (PRIMEGET_QUERY_FINAL_ENABLED())
    PRIMEGET_QUERY_FINAL();</span>

  return 0;
}</pre><div class="infoboxnote">
                        <p class="notep1">Note:</p>
                        
                        <p>
          Any <span class="variable" translate="no">*</span>
                           <code class="codeph">_ENABLED()</code>
          probe will translate into a truth value if the associated
          probe is enabled (some consumer is using it), and a false
          value if the associated probe is not enabled.
        
                        </p>
                        
                     </div>
                     <p>
        Before continuing, ensure that the probes are enabled and appear
        as the macros listed in the <code class="codeph">dprime.h</code> file.
        See
        <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/dtrace-ref-StaticallyDefinedTracingofUserApplications.html#dt_isenabled_sdt" target="_blank">Testing
        if a Probe Is Enabled</a> in the
        <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/" target="_blank">Oracle Linux: DTrace Reference Guide</a>.
      
                     </p>
                     <div class="infoboxnote">
                        <p class="notep1">Note:</p>
                        
                        <p>
          Make sure to include any desired values in the macros, if they
          exist, so that the probe can also identify those values.
        </p>
                        
                     </div>
                     <p>
        Next, you will need to modify the <code class="codeph">makefile</code>
        file. For step-by-step instructions, See
        <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/dtrace-ref-StaticallyDefinedTracingofUserApplications.html#dt_bap_sdt" target="_blank">Building
        Applications With Probes</a> in the
        <a href="https://docs.oracle.com/en/operating-systems/oracle-linux/dtrace-guide/" target="_blank">Oracle Linux: DTrace Reference Guide</a>.
      
                     </p>
                  </div>
               </div>
               <div class="sect3"><a id="usdtadd_addtarget_exercise" name="usdtadd_addtarget_exercise"></a><h4 id="OLDTT-usdtadd_addtarget_exercise" class="sect4">Exercise: Directing makefile to Re-Create the dprime.h File</h4>
                  <div>
                     <p><a id="d5322e885" class="indexterm-anchor"></a>

        Add a target that instructs <kbd class="userinput">dtrace</kbd> to
        re-create the <code class="codeph">dprime.h</code> file in the event that
        changes are subsequently made to the <code class="codeph">dprime.d</code>
        file. This step ensures that you do not have to manually run the
        <kbd class="userinput">dtrace -h -s dprime.d</kbd> command if any changes
        are made.
      
                     </p>
                     <p>
        This exercise also has you direct <kbd class="userinput">dtrace</kbd> to
        create a <code class="codeph">prime.o</code> file.
      
                     </p>
                     <p>
        (Estimated completion time: 10 minutes)
      </p>
                  </div>
               </div>
               <div class="sect3"><a id="usdtadd_directdtrace_solution" name="usdtadd_directdtrace_solution"></a><h4 id="OLDTT-usdtadd_directdtrace_solution" class="sect4">Solution to Exercise: Directing makefile to Re-Create the dprime.h File

        <span></span>
                     
                  </h4>
                  <div><pre class="oac_no_warn" dir="ltr">default: prime

# re-create new dprime.h if dprime.d file has been changed
dprime.h: dprime.d
	dtrace -h -s dprime.d

# compile the library primelib first
primelib.o: primelib.c
	gcc -c primelib.c

# compile the main program
primain.o: primain.c dprime.h
	gcc -c primain.c

# have dtrace post-process the object files
prime.o: dprime.d primelib.o primain.o
	dtrace -G -s dprime.d primelib.o primain.o -o prime.o

# link and create executable file "prime"
prime: prime.o
	gcc -Wl,--export-dynamic,--strip-all -o prime prime.o primelib.o primain.o dprime.h -lm


clean:
	-rm -f *.o
	-rm -f prime
	-rm -f dprime.h</pre></div>
               </div>
               <div class="sect3"><a id="usdtprobes_testprog_example" name="usdtprobes_testprog_example"></a><h4 id="OLDTT-usdtprobes_testprog_example" class="sect4">Example: Testing the Program</h4>
                  <div>
                     <p><a id="d5322e980" class="indexterm-anchor"></a>

        After creating a fresh build, test that the executable is still
        working as expected:
      
                     </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">make clean</kbd>
rm -f *.o
rm -f prime
rm -f dprime.h


# <kbd class="userinput">make</kbd>
gcc -c primelib.c
dtrace -h -s dprime.d
gcc -c primain.c
dtrace -G -s dprime.d primelib.o primain.o -o prime.o
gcc -Wl,--export-dynamic,--strip-all -o prime prime.o primelib.o primain.o dprime.h -lm</pre><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime</kbd>
Enter a positive target integer to test for prime status: 6799
Square root of 6799 is 82.456047
82 highest value to check as divisor
6799 is not prime because there is a factor 13</pre></div>
               </div>
            </div>
            <div class="sect2"><a id="dtrace_use_usdtprobes" name="dtrace_use_usdtprobes"></a><h3 id="OLDTT-dtrace_use_usdtprobes" class="sect3">Using USDT Probes</h3>
               <div>
                  <p>
      This section provides some practice in the nominal use of the USDT
      probes that were created in <a href="dtrace-tutorial-TracingUserSpaceApplications.html#addusdt_probes">Adding USDT Probes to an Application</a>.
    
                  </p>
                  <p>
      Initially, the probes are not visible because the application is
      not running with the probes, as shown in the following output:
    </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -l -P 'prime*'</kbd>
  ID   PROVIDER            MODULE                          FUNCTION NAME
dtrace: failed to match prime*:::: No probe matches description</pre><p>
      Start the application, but do not enter any value until you have
      listed the probes:
    </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status:</pre><p>
      From another command line, issue a probe listing:
    </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -l -P 'prime*'</kbd>
   ID      PROVIDER            MODULE                          FUNCTION NAME
 2475 primeget26556             prime                              main query-factorreturnA
 2476 primeget26556             prime                              main query-factorreturnB
 2477 primeget26556             prime                              main query-final
 2478 primeget26556             prime                              main query-maxcheckval
 2479 primeget26556             prime                              main query-userentry</pre><div class="infoboxnote">
                     <p class="notep1">Note:</p>
                     
                     <p>
        The provider name is a combination of the defined
        <code class="codeph">provider primeget</code>, from the
        <code class="codeph">dprime.d</code> file, and the PID of the running
        application <code class="codeph">prime</code>. The output of the
        following command displays the PID of prime:
      
                     </p>
                     <pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">ps aux | grep prime</kbd>
root 26556 0.0 0.0 7404 1692 pts/0 S+ 21:50 0:00 ./prime</pre>
                     </div>
                  <p>
      If you want to be able to run USDT scripts for users other than
      <code class="codeph">root</code>, the helper device must have the proper
      permissions. Alternatively, you can run the program with the
      probes in it as the <code class="codeph">root</code> user. See
      <a href="dtrace-tutorial-TracingUserSpaceApplications.html#ol_helper_dtrace_mode">Example: Changing the Mode of the DTrace Helper Device</a> for more
      information about changing the mode of the DTrace helper device.
    
                  </p>
                  <p>
      One method for getting these permissions is to run the following
      command to change the configuration so that users other than the
      <code class="codeph">root</code> user can send probe provider information
      to DTrace:
    
                  </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">setfacl -m u:guest:rw /dev/dtrace/helper</kbd></pre><p>
      Start the application again, but do not enter any values until the
      probes are listed:
    </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime</kbd> 
Enter a positive target integer to test for prime status: </pre><p>
      From another command line, issue a probe listing:
    </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -l -P 'prime*'</kbd>
   ID     PROVIDER            MODULE                    FUNCTION NAME
 2456 primeget2069             prime                        main query-factorreturnA
 2457 primeget2069             prime                        main query-factorreturnB
 2458 primeget2069             prime                        main query-final
 2459 primeget2069             prime                        main query-maxcheckval
 2460 primeget2069             prime                        main query-userentry</pre></div>
               <div class="sect3"><a id="dtrace_usdt_simpletimeprobe" name="dtrace_usdt_simpletimeprobe"></a><h4 id="OLDTT-dtrace_usdt_simpletimeprobe" class="sect4">Example: Using simpleTimeProbe.d to Show the Elapsed Time Between Two
        Probes</h4>
                  <div>
                     <p><a id="d5322e1140" class="indexterm-anchor"></a>

        The following example shows how you would create a simple script
        that measures the time elapsed between the first probe and the
        second probe (<code class="codeph">query-userentry</code> to
        <code class="codeph">query-maxcheckval</code>).
      
                     </p><pre class="oac_no_warn" dir="ltr">/* simpleTimeProbe.d */

/* Show how much time elapses between two probes */

primeget*:::query-userentry
{
  self-&gt;t = timestamp; /* Initialize a thread-local variable with the time */
}

primeget*:::query-maxcheckval
/self-&gt;t != 0/
{
  timeNow = timestamp;
  /* Divide by 1000 for microseconds */
  printf("%s (pid=%d) spent %d microseconds between userentry &amp; maxcheckval\n",
         execname, pid, ((timeNow - self-&gt;t)/1000));

  self-&gt;t = 0; /* Reset the variable */
}</pre><p>
        Start the execution of the target application:
      </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime</kbd>
Enter a positive target integer to test for prime status:</pre><p>
        Then, run the DTrace script from another window:
      </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -q -s simpleTimeProbe.d</kbd></pre><p>
        As the application is running, the output of the script is also
        running in parallel:
      </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 7921
Square root of 7921 is 89.000000
89 highest value to check as divisor
7921 is not prime because there is a factor 89
# <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 995099
Square root of 995099 is 997.546509
997 highest value to check as divisor
995099 is not prime because there is a factor 7
# <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 7921
Square root of 7921 is 89.000000
89 highest value to check as divisor
7921 is not prime because there is a factor 89</pre><p>
        On the command line where the script is being run, you should
        see output similar to the following:
      </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -q -s simpleTimeProbe.d</kbd>
prime (pid=2328) spent 45 microseconds between userentry &amp; maxcheckval
prime (pid=2330) spent 41 microseconds between userentry &amp; maxcheckval
prime (pid=2331) spent 89 microseconds between userentry &amp; maxcheckval
<kbd class="userinput">^C
</kbd></pre></div>
               </div>
               <div class="sect3"><a id="usdt_timetweenprobes_1" name="usdt_timetweenprobes_1"></a><h4 id="OLDTT-usdt_timetweenprobes_1" class="sect4">Example: Using timeTweenprobes.d to Show the Elapsed Time Between Each
        Probe</h4>
                  <div>
                     <p><a id="d5322e1218" class="indexterm-anchor"></a>

        You can broaden the script to monitor all of the following
        probes in the application:
      
                     </p>
                     <ul style="list-style-type: disc;">
                        <li>
                           
                           <p>
                              <code class="codeph">query-userentry</code>
                              
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>
                              <code class="codeph">query-maxcheckval</code>
                              
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>
                              <code class="codeph">query-factorreturnA</code>
                              
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>
                              <code class="codeph">query-factorreturnB</code>
                              
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>
                              <code class="codeph">query-final</code>
                              
                           </p>
                           
                        </li>
                     </ul><pre class="oac_no_warn" dir="ltr">/* timeTweenProbes.d */

/* show how much time elapses between each probe */

BEGIN
{
  iterationCount = 0;
}


primeget*:::query-userentry
{
  printf("%s (pid=%d) running\n", execname, pid);
  self-&gt;t = timestamp; /* Initialize a thread-local variable with time */
}

primeget*:::query-maxcheckval
/self-&gt;t != 0/
{
  timeNow = timestamp;
  printf(" maxcheckval spent %d microseconds since userentry\n",
         ((timeNow - self-&gt;t)/1000));  /* Divide by 1000 for microseconds */
  self-&gt;t = timeNow; /* set the time to recent sample */
}

primeget*:::query-factorreturnA
/self-&gt;t != 0/
{
  timeNow = timestamp;
  printf(" factorreturnA spent %d microseconds since maxcheckval\n",
         ((timeNow - self-&gt;t)/1000));  /* Divide by 1000 for microseconds */
  self-&gt;t = timeNow; /* set the time to recent sample */
}

primeget*:::query-factorreturnB
/self-&gt;t != 0/
{
  timeNow = timestamp;
  printf(" factorreturnB spent %d microseconds since factorreturnA\n",
         ((timeNow - self-&gt;t)/1000));  /* Divide by 1000 for microseconds */
  self-&gt;t = timeNow; /* set the time to recent sample */
}

primeget*:::query-final
/self-&gt;t != 0/
{
  printf(" prime spent %d microseconds from factorreturnB until ending\n",
         ((timestamp - self-&gt;t)/1000));
  self-&gt;t = 0; /* Reset the variable */
  iterationCount++;
}

END
{
  trace(iterationCount);
}</pre><p>
        Again, start the execution of the target application first, then
        run the script from another window:
      </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 995099
Square root of 995099 is 997.546509
997 highest value to check as divisor
995099 is not prime because there is a factor 7
# <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 7921
Square root of 7921 is 89.000000
89 highest value to check as divisor
7921 is not prime because there is a factor 89
# <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 95099
Square root of 95099 is 308.381256
308 highest value to check as divisor
95099 is not prime because there is a factor 61
# <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 95099
Square root of 95099 is 308.381256
308 highest value to check as divisor
95099 is not prime because there is a factor 61
# <kbd class="userinput">./prime </kbd>
Enter a positive target integer to test for prime status: 5099         
Square root of 5099 is 71.407280
71 highest value to check as divisor
5099 is a prime number</pre><p>
        The corresponding output from the script is similar to the
        following:
      </p><pre class="oac_no_warn" dir="ltr"># <kbd class="userinput">dtrace -q -s ./timeTweenProbes.d</kbd>
prime (pid=2437) running
 maxcheckval spent 96 microseconds since userentry
 factorreturnA spent 9 microseconds since maxcheckval
 factorreturnB spent 6 microseconds since factorreturnA
 prime spent 9 microseconds from factorreturnB until ending
prime (pid=2439) running
 maxcheckval spent 45 microseconds since userentry
 factorreturnA spent 10 microseconds since maxcheckval
 factorreturnB spent 7 microseconds since factorreturnA
 prime spent 9 microseconds from factorreturnB until ending
prime (pid=2440) running
 maxcheckval spent 43 microseconds since userentry
 factorreturnA spent 11 microseconds since maxcheckval
 factorreturnB spent 8 microseconds since factorreturnA
 prime spent 10 microseconds from factorreturnB until ending
prime (pid=2441) running
 maxcheckval spent 53 microseconds since userentry
 factorreturnA spent 10 microseconds since maxcheckval
 factorreturnB spent 7 microseconds since factorreturnA
 prime spent 10 microseconds from factorreturnB until ending
prime (pid=2442) running
 maxcheckval spent 40 microseconds since userentry
 factorreturnA spent 9 microseconds since maxcheckval
 factorreturnB spent 48 microseconds since factorreturnA
 prime spent 10 microseconds from factorreturnB until ending
<kbd class="userinput">
^C</kbd>
5</pre><p>
        As is observed in the previous example, there is now a set of
        DTrace features that can be used with the probes that were
        created.
      </p>
                  </div>
               </div>
            </div>
         </div>
      </article>
   </body>
</html>